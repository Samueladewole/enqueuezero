<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Markdown Parser | Enqueue Zero</title>
    <meta name="description" content="Enqueue Zero is publishing code principles.">
    
    
    <link rel="preload" href="/assets/css/0.styles.8179f028.css" as="style"><link rel="preload" href="/assets/js/app.a5c5a90d.js" as="script"><link rel="preload" href="/assets/js/96.b9653b96.js" as="script"><link rel="prefetch" href="/assets/js/10.018ae37c.js"><link rel="prefetch" href="/assets/js/100.22197086.js"><link rel="prefetch" href="/assets/js/101.54f8900f.js"><link rel="prefetch" href="/assets/js/102.14e6dfaa.js"><link rel="prefetch" href="/assets/js/103.bc5fe21b.js"><link rel="prefetch" href="/assets/js/104.7c80f93b.js"><link rel="prefetch" href="/assets/js/105.ca3d43a8.js"><link rel="prefetch" href="/assets/js/106.b5a1a7b8.js"><link rel="prefetch" href="/assets/js/107.88dc4bf2.js"><link rel="prefetch" href="/assets/js/108.d27316ac.js"><link rel="prefetch" href="/assets/js/109.c1c3f7d5.js"><link rel="prefetch" href="/assets/js/11.a4d6c639.js"><link rel="prefetch" href="/assets/js/110.5d20362d.js"><link rel="prefetch" href="/assets/js/111.19567cc3.js"><link rel="prefetch" href="/assets/js/112.7a1166db.js"><link rel="prefetch" href="/assets/js/113.a581c843.js"><link rel="prefetch" href="/assets/js/114.f04c0a5d.js"><link rel="prefetch" href="/assets/js/115.a2ef8992.js"><link rel="prefetch" href="/assets/js/116.f51b1cb8.js"><link rel="prefetch" href="/assets/js/117.6b7d8777.js"><link rel="prefetch" href="/assets/js/118.3fe35660.js"><link rel="prefetch" href="/assets/js/119.03a28530.js"><link rel="prefetch" href="/assets/js/12.a363c990.js"><link rel="prefetch" href="/assets/js/120.2e35a8ac.js"><link rel="prefetch" href="/assets/js/121.17e2a843.js"><link rel="prefetch" href="/assets/js/122.5f11d90e.js"><link rel="prefetch" href="/assets/js/123.3c2169bd.js"><link rel="prefetch" href="/assets/js/124.8f97de93.js"><link rel="prefetch" href="/assets/js/125.248f93fd.js"><link rel="prefetch" href="/assets/js/126.be7b49ce.js"><link rel="prefetch" href="/assets/js/127.ba8a13ff.js"><link rel="prefetch" href="/assets/js/128.4f66968d.js"><link rel="prefetch" href="/assets/js/129.1413bbb7.js"><link rel="prefetch" href="/assets/js/13.73c0d89b.js"><link rel="prefetch" href="/assets/js/130.ac5472dd.js"><link rel="prefetch" href="/assets/js/131.8d4dc161.js"><link rel="prefetch" href="/assets/js/132.68b7e465.js"><link rel="prefetch" href="/assets/js/133.79bec4c5.js"><link rel="prefetch" href="/assets/js/134.fa90460e.js"><link rel="prefetch" href="/assets/js/135.9306187f.js"><link rel="prefetch" href="/assets/js/136.b86c2432.js"><link rel="prefetch" href="/assets/js/137.64484ac0.js"><link rel="prefetch" href="/assets/js/138.423a2429.js"><link rel="prefetch" href="/assets/js/139.7d011a69.js"><link rel="prefetch" href="/assets/js/14.ee32880e.js"><link rel="prefetch" href="/assets/js/140.864d5c94.js"><link rel="prefetch" href="/assets/js/141.1fe7b9b2.js"><link rel="prefetch" href="/assets/js/142.23ec1948.js"><link rel="prefetch" href="/assets/js/143.981ad998.js"><link rel="prefetch" href="/assets/js/144.ec0dc002.js"><link rel="prefetch" href="/assets/js/145.aaa80a96.js"><link rel="prefetch" href="/assets/js/146.9f43c059.js"><link rel="prefetch" href="/assets/js/147.743294e7.js"><link rel="prefetch" href="/assets/js/148.1f131e94.js"><link rel="prefetch" href="/assets/js/149.8f4384a4.js"><link rel="prefetch" href="/assets/js/15.bbe22266.js"><link rel="prefetch" href="/assets/js/150.282d9c55.js"><link rel="prefetch" href="/assets/js/151.ac5e5099.js"><link rel="prefetch" href="/assets/js/152.d890f97d.js"><link rel="prefetch" href="/assets/js/153.60c4018e.js"><link rel="prefetch" href="/assets/js/154.d8044b29.js"><link rel="prefetch" href="/assets/js/16.daaa6b7e.js"><link rel="prefetch" href="/assets/js/17.5fa93d15.js"><link rel="prefetch" href="/assets/js/18.5a2a5a8e.js"><link rel="prefetch" href="/assets/js/19.d4cc6828.js"><link rel="prefetch" href="/assets/js/2.c107d922.js"><link rel="prefetch" href="/assets/js/20.f3aed24e.js"><link rel="prefetch" href="/assets/js/21.602e65dc.js"><link rel="prefetch" href="/assets/js/22.7f1ef34d.js"><link rel="prefetch" href="/assets/js/23.dd96e288.js"><link rel="prefetch" href="/assets/js/24.f0393f01.js"><link rel="prefetch" href="/assets/js/25.b3eaf42e.js"><link rel="prefetch" href="/assets/js/26.d11c3e2f.js"><link rel="prefetch" href="/assets/js/27.874eb632.js"><link rel="prefetch" href="/assets/js/28.9d8180e2.js"><link rel="prefetch" href="/assets/js/29.19e670ae.js"><link rel="prefetch" href="/assets/js/3.dcdecd51.js"><link rel="prefetch" href="/assets/js/30.05dd749c.js"><link rel="prefetch" href="/assets/js/31.ba54249e.js"><link rel="prefetch" href="/assets/js/32.a781042e.js"><link rel="prefetch" href="/assets/js/33.f10ca4c8.js"><link rel="prefetch" href="/assets/js/34.c46037b2.js"><link rel="prefetch" href="/assets/js/35.cd1d35ee.js"><link rel="prefetch" href="/assets/js/36.355a3162.js"><link rel="prefetch" href="/assets/js/37.1f45bb31.js"><link rel="prefetch" href="/assets/js/38.b143ec86.js"><link rel="prefetch" href="/assets/js/39.eeea86dc.js"><link rel="prefetch" href="/assets/js/4.cf9a5ee6.js"><link rel="prefetch" href="/assets/js/40.e3c4ecee.js"><link rel="prefetch" href="/assets/js/41.53454ef8.js"><link rel="prefetch" href="/assets/js/42.7bb7b1cc.js"><link rel="prefetch" href="/assets/js/43.178062e3.js"><link rel="prefetch" href="/assets/js/44.3962ed86.js"><link rel="prefetch" href="/assets/js/45.c3196a88.js"><link rel="prefetch" href="/assets/js/46.24affaf5.js"><link rel="prefetch" href="/assets/js/47.6ae747ba.js"><link rel="prefetch" href="/assets/js/48.16b7b683.js"><link rel="prefetch" href="/assets/js/49.aaf4cf5c.js"><link rel="prefetch" href="/assets/js/5.6758d475.js"><link rel="prefetch" href="/assets/js/50.dec004fc.js"><link rel="prefetch" href="/assets/js/51.13c60055.js"><link rel="prefetch" href="/assets/js/52.9df98683.js"><link rel="prefetch" href="/assets/js/53.5621439f.js"><link rel="prefetch" href="/assets/js/54.82938492.js"><link rel="prefetch" href="/assets/js/55.88368350.js"><link rel="prefetch" href="/assets/js/56.9454cb35.js"><link rel="prefetch" href="/assets/js/57.c22a39d6.js"><link rel="prefetch" href="/assets/js/58.dbf5d826.js"><link rel="prefetch" href="/assets/js/59.0eafc181.js"><link rel="prefetch" href="/assets/js/6.6cd77d2f.js"><link rel="prefetch" href="/assets/js/60.647bf7cb.js"><link rel="prefetch" href="/assets/js/61.4f87d8af.js"><link rel="prefetch" href="/assets/js/62.8836d886.js"><link rel="prefetch" href="/assets/js/63.27177f22.js"><link rel="prefetch" href="/assets/js/64.0a5e943f.js"><link rel="prefetch" href="/assets/js/65.7ce3ee50.js"><link rel="prefetch" href="/assets/js/66.85e8a286.js"><link rel="prefetch" href="/assets/js/67.da6aec92.js"><link rel="prefetch" href="/assets/js/68.83e971cb.js"><link rel="prefetch" href="/assets/js/69.0edbe74d.js"><link rel="prefetch" href="/assets/js/7.6bcf3745.js"><link rel="prefetch" href="/assets/js/70.35469e8c.js"><link rel="prefetch" href="/assets/js/71.54e87c3a.js"><link rel="prefetch" href="/assets/js/72.0975e4c9.js"><link rel="prefetch" href="/assets/js/73.2ec68323.js"><link rel="prefetch" href="/assets/js/74.13bf7e04.js"><link rel="prefetch" href="/assets/js/75.3be14426.js"><link rel="prefetch" href="/assets/js/76.bd32ba3e.js"><link rel="prefetch" href="/assets/js/77.b52bb0c4.js"><link rel="prefetch" href="/assets/js/78.3a77b2d8.js"><link rel="prefetch" href="/assets/js/79.c2747e2d.js"><link rel="prefetch" href="/assets/js/8.f71652a1.js"><link rel="prefetch" href="/assets/js/80.4a107658.js"><link rel="prefetch" href="/assets/js/81.75308548.js"><link rel="prefetch" href="/assets/js/82.9383893b.js"><link rel="prefetch" href="/assets/js/83.3b11109d.js"><link rel="prefetch" href="/assets/js/84.6a005d10.js"><link rel="prefetch" href="/assets/js/85.6cea521f.js"><link rel="prefetch" href="/assets/js/86.fa853074.js"><link rel="prefetch" href="/assets/js/87.5d110306.js"><link rel="prefetch" href="/assets/js/88.34eb170e.js"><link rel="prefetch" href="/assets/js/89.65b23b0d.js"><link rel="prefetch" href="/assets/js/9.207749d9.js"><link rel="prefetch" href="/assets/js/90.9793b902.js"><link rel="prefetch" href="/assets/js/91.aab54e09.js"><link rel="prefetch" href="/assets/js/92.db4b3190.js"><link rel="prefetch" href="/assets/js/93.12604934.js"><link rel="prefetch" href="/assets/js/94.49b2a19d.js"><link rel="prefetch" href="/assets/js/95.8f5b4b26.js"><link rel="prefetch" href="/assets/js/97.436b94b7.js"><link rel="prefetch" href="/assets/js/98.aa36e199.js"><link rel="prefetch" href="/assets/js/99.5ea4f990.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8179f028.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enqueue Zero</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="markdown-parser"><a href="#markdown-parser" class="header-anchor">#</a> Markdown Parser</h1> <p>Many people, when confronted writing HTML document, think &quot;Well, HTML is tedious, I'll go with Markdown.&quot; Then they'll face two problems. For programming zealots, they certainly will introduce a third problem: why not write a Markdown parser?</p> <p>In practice, most Markdown parser programs use regular expression or regex for parsing. There are some more options like <a href="https://github.com/jgm/peg-markdown" target="_blank" rel="noopener noreferrer">PEG<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, etc. In this post, we'll write a simple but extensive markdown parser in nim-lang that can perform basic parsing. Beyond that, we'll also discuss how to improve the code to support more Markdown notations and dialects.</p> <h2 id="implementation"><a href="#implementation" class="header-anchor">#</a> Implementation</h2> <h3 id="tokenize"><a href="#tokenize" class="header-anchor">#</a> Tokenize</h3> <p>It's clear that our goal is to convert a markdown document into an HTML document.</p> <p>By introducing a tokenizing step as shown in below flow,
we can make separate of concerns: parsing and rendering.</p> <div class="language- extra-class"><pre class="language-text"><code>+-------------------+    +--------+    +---------------+
| Markdown Document +--&gt; | Tokens +--&gt; | HTML Document |
+-------------------+    +--------+    +---------------+
</code></pre></div><p>The source code below is self-explanatory.</p> <div class="language-nim extra-class"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">markdown<span class="token operator">*</span></span><span class="token punctuation">(</span>doc<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token operator">=</span>
  <span class="token keyword">for</span> token <span class="token operator">in</span> <span class="token function">parseTokens</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token operator">:</span>
      result <span class="token operator">&amp;=</span> <span class="token function">renderToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
</code></pre></div><h3 id="parse"><a href="#parse" class="header-anchor">#</a> Parse</h3> <p>When programming from scratch, it's wise to start from small. So let's pick up
the very feature only - converting <code># Header</code> into <code>&lt;h1&gt;Header&lt;/h1&gt;</code>. We start from
defining a token type and a token value, as you might also do by yourself in any
programming language.</p> <p>Below are some essential definitions for the code we'll write to work.</p> <ul><li>We define a <code>Header</code> container object for storing header level and its content.</li> <li>We define an enum <code>MarkdownTokenType</code> which has only one choice - <code>Header</code>.</li> <li>We also define a reference <code>MarkdownTokenRef</code> as a wrapper for the token.</li></ul> <div class="language-nim extra-class"><pre class="language-nim"><code><span class="token keyword">type</span>
  Header<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span>
    doc<span class="token operator">:</span> string
    level<span class="token operator">:</span> int

  MarkdownTokenType<span class="token operator">*</span> <span class="token punctuation">{.</span>pure<span class="token punctuation">.}</span> <span class="token operator">=</span> <span class="token keyword">enum</span>
    Header

  MarkdownTokenRef<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">ref</span> <span class="token keyword">object</span>
    <span class="token keyword">case</span> <span class="token keyword">type</span><span class="token operator">*:</span> MarkdownTokenType
    <span class="token operator">of</span> MarkdownTokenType<span class="token operator">.</span>Header<span class="token operator">:</span> headerVal<span class="token operator">*:</span> Header

  MarkdownError<span class="token operator">*</span> <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">of</span> Exception
</code></pre></div><p>The token parsing is a complete iteration through the Markdown string <code>doc</code>.
We find token from the first character of the <code>doc</code> and then move to
the nth character, and on and on until the end. We'll cover the implementation
of <code>findToken</code> later.</p> <div class="language-nim extra-class"><pre class="language-nim"><code><span class="token keyword">iterator</span> <span class="token function">parseTokens</span><span class="token punctuation">(</span>doc<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> MarkdownTokenRef <span class="token operator">=</span>
  <span class="token keyword">var</span> n <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">while</span> n <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token keyword">var</span> token<span class="token operator">:</span> MarkdownTokenRef <span class="token operator">=</span> <span class="token keyword">nil</span>
    <span class="token keyword">for</span> <span class="token keyword">type</span> <span class="token operator">in</span> <span class="token punctuation">[</span>
        MarkdownTokenType<span class="token operator">.</span>Header<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token operator">:</span>
      token <span class="token operator">=</span> <span class="token function">findToken</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> token <span class="token operator">!=</span> <span class="token keyword">nil</span><span class="token operator">:</span>
        <span class="token keyword">yield</span> token
        <span class="token keyword">break</span>
    <span class="token keyword">if</span> token <span class="token operator">==</span> <span class="token keyword">nil</span><span class="token operator">:</span>
      <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>MarkdownError<span class="token punctuation">,</span> <span class="token string">fmt&quot;unknown block rule at position {n}.&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="render"><a href="#render" class="header-anchor">#</a> Render</h3> <p>It's getting easier to generate HTML documents by constructing strings given a token data structure.</p> <div class="language-nim extra-class"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">renderToken</span><span class="token punctuation">(</span>token<span class="token operator">:</span> MarkdownTokenRef<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token operator">=</span>
  <span class="token keyword">case</span> token<span class="token operator">.</span><span class="token keyword">type</span>
  <span class="token operator">of</span> MarkdownTokenType<span class="token operator">.</span>Header<span class="token operator">:</span>
    <span class="token keyword">let</span> header <span class="token operator">=</span> token<span class="token operator">.</span>headerVal
    result <span class="token operator">=</span> <span class="token string">fmt&quot;&lt;h{header.level}&gt;{header.doc}&lt;/h{header.level}&gt;&quot;</span>
</code></pre></div><h3 id="find-token"><a href="#find-token" class="header-anchor">#</a> Find Token</h3> <p>Embed in the heart zone of <code>parseTokens</code>, the function <code>findToken</code> is in the center
of the Markdown parser program.</p> <ul><li>We define a table of token regex rules.</li> <li>We check if the given <code>doc</code> from a specific position <code>start</code> matches the given rule.</li> <li>If so, we construct a container object as the token, otherwise, ignore the check.</li></ul> <div class="language-nim extra-class"><pre class="language-nim"><code><span class="token keyword">let</span> blockRules <span class="token operator">=</span> <span class="token punctuation">{</span>
  MarkdownTokenType<span class="token operator">.</span>Header<span class="token operator">:</span> <span class="token string">re&quot;^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">.</span>toTable

<span class="token keyword">proc</span> <span class="token function">findToken</span><span class="token punctuation">(</span>doc<span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token keyword">var</span> int<span class="token punctuation">,</span> ruleType<span class="token operator">:</span> MarkdownTokenType<span class="token punctuation">)</span><span class="token operator">:</span> MarkdownTokenRef <span class="token operator">=</span>
  <span class="token keyword">let</span> regex <span class="token operator">=</span> blockRules<span class="token punctuation">[</span>ruleType<span class="token punctuation">]</span>
  <span class="token keyword">var</span> matches<span class="token operator">:</span> array<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> string<span class="token punctuation">]</span>

  <span class="token keyword">let</span> size <span class="token operator">=</span> doc<span class="token punctuation">[</span>start <span class="token operator">..</span> doc<span class="token operator">.</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token function">matchLen</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> matches<span class="token operator">=</span>matches<span class="token punctuation">)</span>
  <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>

  <span class="token keyword">case</span> ruleType
  <span class="token operator">of</span> MarkdownTokenType<span class="token operator">.</span>Header<span class="token operator">:</span>
    val<span class="token operator">.</span>level <span class="token operator">=</span> matches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.</span>len
    val<span class="token operator">.</span>doc <span class="token operator">=</span> matches<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    result <span class="token operator">=</span> <span class="token function">MarkdownTokenRef</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token operator">:</span> MarkdownTokenType<span class="token operator">.</span>Header<span class="token punctuation">,</span> headerVal<span class="token operator">:</span> val<span class="token punctuation">)</span> 

  start <span class="token operator">+=</span> size
</code></pre></div><h3 id="get-it-to-work"><a href="#get-it-to-work" class="header-anchor">#</a> Get it to work</h3> <p>Combine all the above code together, we will get a function that can parse <code># h1</code> to <code>&lt;h1&gt;h1&lt;/h1&gt;</code> and <code>## h2</code> to <code>&lt;h2&gt;h2&lt;/h2&gt;</code>. The code is saved as a gist here: <a href="https://gist.github.com/soasme/1a5271090250baed7936b5ac451e50c2" target="_blank" rel="noopener noreferrer">https://gist.github.com/soasme/1a5271090250baed7936b5ac451e50c2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="discussion"><a href="#discussion" class="header-anchor">#</a> Discussion</h2> <p>The function <code>markdown(doc)</code> converts the markdown document to HTML document. It could lead to a <code>MarkdownError</code> exception when sending non-header markdown document into above least implemented code.  If the <code>markdown()</code> function is given the parameter as <code># h1\n## h2</code>, then something interesting will happen.</p> <p>The regex <code>re&quot;^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)&quot;</code> is in charge of matching header texts.</p> <p><img src="/static/images/markdown-parser-header-regex.svg" alt="Header Regex Rule"></p> <p>The function <code>findToken</code> has below internal process.</p> <ul><li>Match <code># h1\n</code> first,</li> <li>Extract <code>#</code> as group 1,</li> <li>Extract <code>h1</code> as group 2,</li> <li>Create a token: <code>MarkdownToken&lt;type: Header, headerVal: Header(level: 1, doc: &quot;h1&quot;)&gt;</code>.</li></ul> <p>Since we paused at the end of <code># h1\n</code>, the function <code>parseTokens</code> will start from <code>## h2</code> after handling <code># h1\n</code>. Similarly, the above function generate a token wrapping <code>Header(level: 2, doc: &quot;h2&quot;)</code>.</p> <p>Here we reach the end of the <code>doc</code>, so <code>parseTokens</code> decides to stop and hand over the job to <code>renderToken</code>.</p> <ul><li>The function <code>renderToken</code> converts <code>Header(level: 1, doc: &quot;h1&quot;)</code> to <code>&lt;h1&gt;h1&lt;/h1&gt;</code>.</li> <li>It also converts <code>Header(level: 2, doc: &quot;h2&quot;)</code> to <code>&lt;h2&gt;h2&lt;/h2&gt;</code>.</li></ul> <p>The above code is very rudimentary as a markdown parser, yet it provides us with an extensive framework.</p> <h2 id="building-on-it"><a href="#building-on-it" class="header-anchor">#</a> Building on It</h2> <p>By building small features one by one, the program becomes more feature completeness. Below will discuss how to adopt new features in the above code</p> <ul><li>Hrule can convert <code>---</code> to <code>&lt;hr&gt;</code>. The implementation can follow a similar pattern as <code>Header</code>. The trick of regex is that we need to match quite a lot of patterns like <code>---</code>, <code>****</code>, <code>____</code>, and so on. It wouldn't be difficult if we append <code>[-*_]{2,}</code> right after <code>[-*_]</code>.</li> <li>IndentedBlockCode allows a block of code with four spaces as the indent. The regex is amazingly short: <code>( {4}[^\n]+\n*)+</code>. The rendering code puts the code content into <code>&lt;pre&gt;&lt;code&gt;{code}&lt;/code&gt;&lt;/pre&gt;</code>.</li> <li>Fences allows codes wrapped into a sequence of ``` characters.  We can add a new rule just like IndentedBlockCode, but change <code>{4}</code> to `{3}.</li> <li>Paragraph is the most often seen block that ends with two or more newlines. Well, technically, if the last paragraph in the document doesn't need to have two or more newlines.  We need to parse the paragraph after matching the other rules, which requires us defining a <code>parsingOrder</code> to help <code>findToken</code> decide the order explicitly.</li> <li>DefineLink creates a definition of the link and let us reference it in the post. It need to match syntax like <code>[ref]: link</code> or <code>[ref]: &lt;link&gt; &quot;title&quot;</code>. Since the use of <code>[ref]</code> can appear ahead of the definition, it implies rendering right after parsing through iteration is not enough. We can introduce a <code>MarkdownContext</code> to the <code>markdown(doc)</code> function. In the <code>MarkdownContext</code>, we build a table of links with their definitions so that in rendering we know which link to apply to the reference.</li></ul> <div class="language-nim extra-class"><pre class="language-nim"><code><span class="token comment"># +-------------------+    +--------+                    +---------------+</span>
<span class="token comment"># | Markdown Document +--&gt; | Tokens +--(build context)-&gt; | HTML Document |</span>
<span class="token comment"># +-------------------+    +--------+                    +---------------+</span>
<span class="token keyword">let</span> tokens <span class="token operator">=</span> <span class="token function">toSeq</span><span class="token punctuation">(</span><span class="token function">parseTokens</span><span class="token punctuation">(</span><span class="token function">preprocessing</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">,</span> blockParsingOrder<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ctx <span class="token operator">=</span> <span class="token function">buildContext</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>
<span class="token keyword">for</span> token <span class="token operator">in</span> tokens<span class="token operator">:</span>
      result <span class="token operator">&amp;=</span> <span class="token function">renderToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> token<span class="token punctuation">)</span>
</code></pre></div><ul><li>DefineFootnote has similar syntax like DefineLink, <code>[^ref]: footnote</code> except it gets translated into <code>&lt;sup&gt;ref&lt;/sup&gt;</code> in the middle of the HTML document and a list of footnotes in the end. So the implementation can be similar to the DefineLink.</li> <li>List supports nested definition. So after matching the list, we need parsing the text of each element again to a sequence of tokens. The process is recursive.</li> <li>...</li></ul> <h2 id="test-driven-development"><a href="#test-driven-development" class="header-anchor">#</a> Test-Driven Development</h2> <p>Building new feature can be test-driven - write a unit test case before adding code. The tests have below form. When applying to a new feature, you can add a case, replacing input and output. Besides, we can leverage tools like <code>watchdog</code> to watch code modifications and run tests automatically.</p> <div class="language-nim extra-class"><pre class="language-nim"><code>test <span class="token string">&quot;header&quot;</span><span class="token operator">:</span>
  check <span class="token function">markdown</span><span class="token punctuation">(</span><span class="token string">&quot;# h1&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;&lt;h1&gt;h1&lt;/h1&gt;&quot;</span>
</code></pre></div><h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>Building a markdown parser from scratch is delightful.  In hindsight, though the initial implementation is short, there are some reasons building from small code.</p> <p>First, without too much code reading, it's easy to have an insight into the data flow and internal process.</p> <p>Second, incrementally adding small code for a feature and keeping tests passes is a win. We gain positive feedbacks and strong confidence.</p> <p>Third, type annotations never miss coverage a case. At first, we write code for one type. Later on, with adding more codes, the type annotation handles all the heavy lifts checking the missing spot. If you forget adding code for a new type, the editor complaints about it.</p> <h2 id="credit"><a href="#credit" class="header-anchor">#</a> Credit</h2> <p>I've published the completed code as a nim package <a href="https://github.com/soasme/nim-markdown" target="_blank" rel="noopener noreferrer">soasme/nim-markdown<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
But I don't want to steal the thunder - the original idea of the code was from <a href="https://github.com/lepture/mistune" target="_blank" rel="noopener noreferrer">lepture/mistune<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, one of my favorite markdown parser implementations. 😃</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/soasme/enqueuezero/edit/master/markdown-parser.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.a5c5a90d.js" defer></script><script src="/assets/js/96.b9653b96.js" defer></script>
  </body>
</html>
