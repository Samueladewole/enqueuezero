<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The Architecture of APScheduler | Enqueue Zero</title>
    <meta name="description" content="Enqueue Zero is publishing code principles.">
    
    
    <link rel="preload" href="/assets/css/0.styles.8179f028.css" as="style"><link rel="preload" href="/assets/js/app.a5c5a90d.js" as="script"><link rel="preload" href="/assets/js/47.6ae747ba.js" as="script"><link rel="prefetch" href="/assets/js/10.018ae37c.js"><link rel="prefetch" href="/assets/js/100.22197086.js"><link rel="prefetch" href="/assets/js/101.54f8900f.js"><link rel="prefetch" href="/assets/js/102.14e6dfaa.js"><link rel="prefetch" href="/assets/js/103.bc5fe21b.js"><link rel="prefetch" href="/assets/js/104.7c80f93b.js"><link rel="prefetch" href="/assets/js/105.ca3d43a8.js"><link rel="prefetch" href="/assets/js/106.b5a1a7b8.js"><link rel="prefetch" href="/assets/js/107.88dc4bf2.js"><link rel="prefetch" href="/assets/js/108.d27316ac.js"><link rel="prefetch" href="/assets/js/109.c1c3f7d5.js"><link rel="prefetch" href="/assets/js/11.a4d6c639.js"><link rel="prefetch" href="/assets/js/110.5d20362d.js"><link rel="prefetch" href="/assets/js/111.19567cc3.js"><link rel="prefetch" href="/assets/js/112.7a1166db.js"><link rel="prefetch" href="/assets/js/113.a581c843.js"><link rel="prefetch" href="/assets/js/114.f04c0a5d.js"><link rel="prefetch" href="/assets/js/115.a2ef8992.js"><link rel="prefetch" href="/assets/js/116.f51b1cb8.js"><link rel="prefetch" href="/assets/js/117.6b7d8777.js"><link rel="prefetch" href="/assets/js/118.3fe35660.js"><link rel="prefetch" href="/assets/js/119.03a28530.js"><link rel="prefetch" href="/assets/js/12.a363c990.js"><link rel="prefetch" href="/assets/js/120.2e35a8ac.js"><link rel="prefetch" href="/assets/js/121.17e2a843.js"><link rel="prefetch" href="/assets/js/122.5f11d90e.js"><link rel="prefetch" href="/assets/js/123.3c2169bd.js"><link rel="prefetch" href="/assets/js/124.8f97de93.js"><link rel="prefetch" href="/assets/js/125.248f93fd.js"><link rel="prefetch" href="/assets/js/126.be7b49ce.js"><link rel="prefetch" href="/assets/js/127.ba8a13ff.js"><link rel="prefetch" href="/assets/js/128.4f66968d.js"><link rel="prefetch" href="/assets/js/129.1413bbb7.js"><link rel="prefetch" href="/assets/js/13.73c0d89b.js"><link rel="prefetch" href="/assets/js/130.ac5472dd.js"><link rel="prefetch" href="/assets/js/131.8d4dc161.js"><link rel="prefetch" href="/assets/js/132.68b7e465.js"><link rel="prefetch" href="/assets/js/133.79bec4c5.js"><link rel="prefetch" href="/assets/js/134.fa90460e.js"><link rel="prefetch" href="/assets/js/135.9306187f.js"><link rel="prefetch" href="/assets/js/136.b86c2432.js"><link rel="prefetch" href="/assets/js/137.64484ac0.js"><link rel="prefetch" href="/assets/js/138.423a2429.js"><link rel="prefetch" href="/assets/js/139.7d011a69.js"><link rel="prefetch" href="/assets/js/14.ee32880e.js"><link rel="prefetch" href="/assets/js/140.864d5c94.js"><link rel="prefetch" href="/assets/js/141.1fe7b9b2.js"><link rel="prefetch" href="/assets/js/142.23ec1948.js"><link rel="prefetch" href="/assets/js/143.981ad998.js"><link rel="prefetch" href="/assets/js/144.ec0dc002.js"><link rel="prefetch" href="/assets/js/145.aaa80a96.js"><link rel="prefetch" href="/assets/js/146.9f43c059.js"><link rel="prefetch" href="/assets/js/147.743294e7.js"><link rel="prefetch" href="/assets/js/148.1f131e94.js"><link rel="prefetch" href="/assets/js/149.8f4384a4.js"><link rel="prefetch" href="/assets/js/15.bbe22266.js"><link rel="prefetch" href="/assets/js/150.282d9c55.js"><link rel="prefetch" href="/assets/js/151.ac5e5099.js"><link rel="prefetch" href="/assets/js/152.d890f97d.js"><link rel="prefetch" href="/assets/js/153.60c4018e.js"><link rel="prefetch" href="/assets/js/154.d8044b29.js"><link rel="prefetch" href="/assets/js/16.daaa6b7e.js"><link rel="prefetch" href="/assets/js/17.5fa93d15.js"><link rel="prefetch" href="/assets/js/18.5a2a5a8e.js"><link rel="prefetch" href="/assets/js/19.d4cc6828.js"><link rel="prefetch" href="/assets/js/2.c107d922.js"><link rel="prefetch" href="/assets/js/20.f3aed24e.js"><link rel="prefetch" href="/assets/js/21.602e65dc.js"><link rel="prefetch" href="/assets/js/22.7f1ef34d.js"><link rel="prefetch" href="/assets/js/23.dd96e288.js"><link rel="prefetch" href="/assets/js/24.f0393f01.js"><link rel="prefetch" href="/assets/js/25.b3eaf42e.js"><link rel="prefetch" href="/assets/js/26.d11c3e2f.js"><link rel="prefetch" href="/assets/js/27.874eb632.js"><link rel="prefetch" href="/assets/js/28.9d8180e2.js"><link rel="prefetch" href="/assets/js/29.19e670ae.js"><link rel="prefetch" href="/assets/js/3.dcdecd51.js"><link rel="prefetch" href="/assets/js/30.05dd749c.js"><link rel="prefetch" href="/assets/js/31.ba54249e.js"><link rel="prefetch" href="/assets/js/32.a781042e.js"><link rel="prefetch" href="/assets/js/33.f10ca4c8.js"><link rel="prefetch" href="/assets/js/34.c46037b2.js"><link rel="prefetch" href="/assets/js/35.cd1d35ee.js"><link rel="prefetch" href="/assets/js/36.355a3162.js"><link rel="prefetch" href="/assets/js/37.1f45bb31.js"><link rel="prefetch" href="/assets/js/38.b143ec86.js"><link rel="prefetch" href="/assets/js/39.eeea86dc.js"><link rel="prefetch" href="/assets/js/4.cf9a5ee6.js"><link rel="prefetch" href="/assets/js/40.e3c4ecee.js"><link rel="prefetch" href="/assets/js/41.53454ef8.js"><link rel="prefetch" href="/assets/js/42.7bb7b1cc.js"><link rel="prefetch" href="/assets/js/43.178062e3.js"><link rel="prefetch" href="/assets/js/44.3962ed86.js"><link rel="prefetch" href="/assets/js/45.c3196a88.js"><link rel="prefetch" href="/assets/js/46.24affaf5.js"><link rel="prefetch" href="/assets/js/48.16b7b683.js"><link rel="prefetch" href="/assets/js/49.aaf4cf5c.js"><link rel="prefetch" href="/assets/js/5.6758d475.js"><link rel="prefetch" href="/assets/js/50.dec004fc.js"><link rel="prefetch" href="/assets/js/51.13c60055.js"><link rel="prefetch" href="/assets/js/52.9df98683.js"><link rel="prefetch" href="/assets/js/53.5621439f.js"><link rel="prefetch" href="/assets/js/54.82938492.js"><link rel="prefetch" href="/assets/js/55.88368350.js"><link rel="prefetch" href="/assets/js/56.9454cb35.js"><link rel="prefetch" href="/assets/js/57.c22a39d6.js"><link rel="prefetch" href="/assets/js/58.dbf5d826.js"><link rel="prefetch" href="/assets/js/59.0eafc181.js"><link rel="prefetch" href="/assets/js/6.6cd77d2f.js"><link rel="prefetch" href="/assets/js/60.647bf7cb.js"><link rel="prefetch" href="/assets/js/61.4f87d8af.js"><link rel="prefetch" href="/assets/js/62.8836d886.js"><link rel="prefetch" href="/assets/js/63.27177f22.js"><link rel="prefetch" href="/assets/js/64.0a5e943f.js"><link rel="prefetch" href="/assets/js/65.7ce3ee50.js"><link rel="prefetch" href="/assets/js/66.85e8a286.js"><link rel="prefetch" href="/assets/js/67.da6aec92.js"><link rel="prefetch" href="/assets/js/68.83e971cb.js"><link rel="prefetch" href="/assets/js/69.0edbe74d.js"><link rel="prefetch" href="/assets/js/7.6bcf3745.js"><link rel="prefetch" href="/assets/js/70.35469e8c.js"><link rel="prefetch" href="/assets/js/71.54e87c3a.js"><link rel="prefetch" href="/assets/js/72.0975e4c9.js"><link rel="prefetch" href="/assets/js/73.2ec68323.js"><link rel="prefetch" href="/assets/js/74.13bf7e04.js"><link rel="prefetch" href="/assets/js/75.3be14426.js"><link rel="prefetch" href="/assets/js/76.bd32ba3e.js"><link rel="prefetch" href="/assets/js/77.b52bb0c4.js"><link rel="prefetch" href="/assets/js/78.3a77b2d8.js"><link rel="prefetch" href="/assets/js/79.c2747e2d.js"><link rel="prefetch" href="/assets/js/8.f71652a1.js"><link rel="prefetch" href="/assets/js/80.4a107658.js"><link rel="prefetch" href="/assets/js/81.75308548.js"><link rel="prefetch" href="/assets/js/82.9383893b.js"><link rel="prefetch" href="/assets/js/83.3b11109d.js"><link rel="prefetch" href="/assets/js/84.6a005d10.js"><link rel="prefetch" href="/assets/js/85.6cea521f.js"><link rel="prefetch" href="/assets/js/86.fa853074.js"><link rel="prefetch" href="/assets/js/87.5d110306.js"><link rel="prefetch" href="/assets/js/88.34eb170e.js"><link rel="prefetch" href="/assets/js/89.65b23b0d.js"><link rel="prefetch" href="/assets/js/9.207749d9.js"><link rel="prefetch" href="/assets/js/90.9793b902.js"><link rel="prefetch" href="/assets/js/91.aab54e09.js"><link rel="prefetch" href="/assets/js/92.db4b3190.js"><link rel="prefetch" href="/assets/js/93.12604934.js"><link rel="prefetch" href="/assets/js/94.49b2a19d.js"><link rel="prefetch" href="/assets/js/95.8f5b4b26.js"><link rel="prefetch" href="/assets/js/96.b9653b96.js"><link rel="prefetch" href="/assets/js/97.436b94b7.js"><link rel="prefetch" href="/assets/js/98.aa36e199.js"><link rel="prefetch" href="/assets/js/99.5ea4f990.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8179f028.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enqueue Zero</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"> <a href="https://github.com/soasme/enqueuezero" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </div> <div class="page"> <div class="content"><h1 id="the-architecture-of-apscheduler"><a href="#the-architecture-of-apscheduler" class="header-anchor">#</a> The Architecture of APScheduler</h1> <p></p><div class="table-of-contents"><ul><li><a href="#overview">Overview</a></li><li><a href="#use">Use</a></li><li><a href="#concepts">Concepts</a><ul><li><a href="#job">Job</a></li><li><a href="#trigger">Trigger</a></li><li><a href="#scheduler">Scheduler</a></li><li><a href="#jobstore">JobStore</a></li><li><a href="#executor">Executor</a></li></ul></li><li><a href="#object-oriented-programming">Object-Oriented Programming</a></li><li><a href="#executor-models">Executor Models</a><ul><li><a href="#sleep-process-model">Sleep-Process Model</a></li><li><a href="#callback-model">Callback Model</a></li></ul></li><li><a href="#time-is-of-the-essence">Time Is of the Essence</a></li><li><a href="#locking-for-job-state-modifications">Locking for Job State Modifications</a><ul><li><a href="#missing-job-executions">Missing Job Executions</a></li><li><a href="#concurrent-job-executions">Concurrent Job Executions</a></li><li><a href="#internal-lock">Internal Lock</a></li></ul></li><li><a href="#event-listeners">Event Listeners</a></li><li><a href="#framework-over-utility">Framework Over Utility</a></li><li><a href="#conclusions">Conclusions</a><ul><li><a href="#some-ideas">Some ideas</a></li><li><a href="#lesson-learned">Lesson learned</a></li></ul></li></ul></div><p></p> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>APScheduler is a job scheduling framework that executes code either one-off or periodically. People often integrate it into an existing Python application for running interval jobs.</p> <p>In this post, we will cover below topics:</p> <ul><li>What are the basic concepts of APScheduler?</li> <li>How does object-oriented programming help extending the use cases?</li> <li>How does the scheduler determine the next run time of jobs?</li> <li>What if a job miss fired?</li> <li>What if too many jobs running simultaneously?</li></ul> <h2 id="use"><a href="#use" class="header-anchor">#</a> Use</h2> <ul><li>Desktop application written in Python can sync data from server per-minute jobs.</li> <li>Web application written in Python can renew hot-sale list every hour on a landing page.</li> <li>Gaming server-side application written in Twisted (A Python network framework) can re-create monsters back to the scene every 5 minutes.</li> <li>Run it in AWS and replace Cronjob. <a href="https://engblog.nextdoor.com/we-don-t-run-cron-jobs-at-nextdoor-6f7f9cc62040" target="_blank" rel="noopener noreferrer">1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="concepts"><a href="#concepts" class="header-anchor">#</a> Concepts</h2> <h3 id="job"><a href="#job" class="header-anchor">#</a> Job</h3> <p>Job houses the functions to execute, the function parameters to pass in, and a bunch of controlling parameters.</p> <p>The functions could be either an imported function or a string of import path. The function arguments are essential for the execution. The controlling parameters are for controlling scheduler behaviors.</p> <p>In below example, <code>tick</code> is the Python function to scheduler, <code>args=(1, )</code> is the function parameter, and <code>trigger='interval', seconds=3</code> are the controlling parameters.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">tick</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># do something</span>

scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>function<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> trigger<span class="token operator">=</span><span class="token string">'interval'</span><span class="token punctuation">,</span> seconds<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
</code></pre></div><h3 id="trigger"><a href="#trigger" class="header-anchor">#</a> Trigger</h3> <p>Triggers contain essential time information for the scheduler. Each job has its trigger.</p> <p>The most important thing a trigger does is to tell the scheduler when is the next time this job should run.</p> <p>For example, in above example, if the job fires at <code>&quot;2000-01-01T00:00:00Z&quot;</code>, then the trigger with 3 seconds as interval should report that the next time is <code>&quot;2000-01-01T00:00:03Z&quot;</code>.</p> <h3 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h3> <p>Schedulers rules all stuff. You can think of it as a stable API provided by APScheduler for configuring JobStores, Executors and adding jobs.</p> <h3 id="jobstore"><a href="#jobstore" class="header-anchor">#</a> JobStore</h3> <p>JobStore houses the scheduled jobs. Without any configuration, APScheduler saves them in memory. As shown in above code, <code>scheduler.add_job</code> won't trigger the function but save the job data into the memory.</p> <p>In below example, APScheduler adds a JobStore named <code>sqlalchemy</code>. The job added later chooses <code>sqlalchemy</code> as its JobStore. The JobStore persists the job into an SQLite database.</p> <div class="language-python extra-class"><pre class="language-python"><code>scheduler<span class="token punctuation">.</span>add_jobstore<span class="token punctuation">(</span><span class="token string">'sqlalchemy'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token string">'sqlite:////sched.db'</span><span class="token punctuation">)</span>
scheduler<span class="token punctuation">.</span>add_job<span class="token punctuation">(</span>function<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> trigger<span class="token operator">=</span><span class="token string">'interval'</span><span class="token punctuation">,</span> seconds<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> jobstore<span class="token operator">=</span><span class="token string">'sqlalchemy'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="executor"><a href="#executor" class="header-anchor">#</a> Executor</h3> <p>Executors run the jobs. They manage the life cycles of jobs. By default, you can use thread or process as executors.</p> <h2 id="object-oriented-programming"><a href="#object-oriented-programming" class="header-anchor">#</a> Object-Oriented Programming</h2> <p>Below is the graph of the relations between all major classes in APScheduler codebase <a href="https://github.com/agronholm/apscheduler" target="_blank" rel="noopener noreferrer">2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p><img src="/static/images/apscheduler-oo.png" alt="APScheduler Class Graph"></p> <ul><li>The <code>BaseScheduler</code>, <code>BaseExecutor</code>, <code>BaseJobStore</code> and <code>BaseTrigger</code> implements major functionalities of corespondent concepts.</li> <li>The subclasses of base class adapt the base implementation to specific frameworks or libraries to cover more use cases.</li> <li>The scheduler manages executor and jobstore.</li> <li>The jobstore stores all of the jobs.</li> <li>Each job has its trigger.</li></ul> <p>Choosing a proper scheduler, job store(s), executor(s) and trigger(s) depends on the user's current technology stack.</p> <p>If all of the implementations cannot fit user's demand, then it's easy to follow the same pattern to extend them. <a href="https://apscheduler.readthedocs.io/en/latest/extending.html" target="_blank" rel="noopener noreferrer">3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="executor-models"><a href="#executor-models" class="header-anchor">#</a> Executor Models</h2> <p>There are two primary models of how scheduler schedules jobs in APScheduler.</p> <p>In below two models, the scheduler internal method <code>process_jobs</code> trigger jobs and return seconds to sleep. The other function <code>sleep</code> or <code>run_after_timeout</code> would idle the scheduler for a few seconds.</p> <h3 id="sleep-process-model"><a href="#sleep-process-model" class="header-anchor">#</a> Sleep-Process Model</h3> <p>The sleep-process model is implemented in an infinite loop of sleeping and job processing.</p> <div class="language-python extra-class"><pre class="language-python"><code>timeout <span class="token operator">=</span> DEFAULT
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span> 
    sleep<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
    timeout <span class="token operator">=</span> process_jobs<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>It's commonly seen in blocking applications. Please check to the implementation of <a href="https://github.com/agronholm/apscheduler/blob/master/apscheduler/schedulers/blocking.py" target="_blank" rel="noopener noreferrer">blocking.py<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for example.</p> <h3 id="callback-model"><a href="#callback-model" class="header-anchor">#</a> Callback Model</h3> <p>The callback model is implemented in a callback-chain convention.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>timeout<span class="token operator">=</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">:</span>
    run_after_timeout<span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> wakeup<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    timeout <span class="token operator">=</span> process_jobs<span class="token punctuation">(</span><span class="token punctuation">)</span>
    start<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>It's commonly seen in non-blocking applications. Please check the implementation of <a href="https://github.com/agronholm/apscheduler/blob/master/apscheduler/schedulers/tornado.py" target="_blank" rel="noopener noreferrer">tornado.py<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for example.</p> <h2 id="time-is-of-the-essence"><a href="#time-is-of-the-essence" class="header-anchor">#</a> Time Is of the Essence</h2> <p>Although the scheduler is all about executing the job at a specific time, it doesn't guarantee the job will be executed definitely. That's one of the most important things you need to have in your mind. Two primary factors would affect it:</p> <ul><li>The scheduler implementation.</li> <li><strong>Current running job numbers</strong>.</li> <li><strong>Current system load</strong>.</li></ul> <p>If the system load is high, the scheduler might choose to drop some jobs since it needs to execute new jobs. It's similar to the case of queueing-up.It's recommended not to put CPU-bound operations in the same machine of where APScheduler is running.</p> <p>Besides, the sleep operation depends on OS or VM scheduler, which is much low-level scheduler behind the scene. The OS does not guarantee it suspends the process exactly the same amount of time specified by <code>timeout</code>. <a href="https://stackoverflow.com/questions/1719071/how-is-sleep-implemented-at-the-os-level" target="_blank" rel="noopener noreferrer">4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="locking-for-job-state-modifications"><a href="#locking-for-job-state-modifications" class="header-anchor">#</a> Locking for Job State Modifications</h2> <h3 id="missing-job-executions"><a href="#missing-job-executions" class="header-anchor">#</a> Missing Job Executions</h3> <p>Since the scheduler sometimes misses triggering jobs, APScheduler leaves the question to the end-users if the job should be triggered when the job passed the time.</p> <div class="language- extra-class"><pre class="language-text"><code>|----x-------()?------x--------x------|

x: job triggered
(): job miss triggered
?: should the job be triggered afterward?
</code></pre></div><p>To solve this problem, APScheduler provides a controlling parameter <code>misfire_grace_time</code> for each job. If the job passed the scheduled time but still within the <code>misfire_grace_time</code>, then it would be triggered still.</p> <p>Additionally, you can choose another option by using controlling parameter <code>coalescing</code> to roll all missed executions into one.</p> <h3 id="concurrent-job-executions"><a href="#concurrent-job-executions" class="header-anchor">#</a> Concurrent Job Executions</h3> <p>Sometimes the job might be triggered even when another instance of the job is running. It happens when the job takes a long time to run and the next job just catches up.</p> <div class="language- extra-class"><pre class="language-text"><code>|----x--------()--------xx?-----x------|

x: job triggered
(): job miss triggered
?: should the two jobs both run?
</code></pre></div><p>To solve this problem, APScheduler provides another controlling parameter <code>max_instances</code> for end users.</p> <h3 id="internal-lock"><a href="#internal-lock" class="header-anchor">#</a> Internal Lock</h3> <p>To support <code>misfire_grace_time</code>, <code>coalescing</code>, and <code>max_instances</code>, APScheduler puts a lot of efforts into managing job state and their run times.</p> <p>Since the jobs might runs concurrently, APScheduler has to acquire a lock onto jobstore for any job data modifications.</p> <h2 id="event-listeners"><a href="#event-listeners" class="header-anchor">#</a> Event Listeners</h2> <p>Except for the job management API, APScheduler also provides a lightweight event system for a certain number of events.</p> <p>APScheduler fires events on certain occasions so that user code can listen to them.</p> <p>Below is an example of how apscheduler report job errors via prometheus:</p> <div class="language- extra-class"><pre class="language-text"><code>def report_error(event):
    if event.exception:
        PROM_ERROR_METRICS.inc()

scheduler.add_listener(report_error, EVENT_JOB_ERROR)
</code></pre></div><h2 id="framework-over-utility"><a href="#framework-over-utility" class="header-anchor">#</a> Framework Over Utility</h2> <p>It's an intended design goal to make APScheduler a cross-platform, cross-application scheduler framework, rather than a daemon or service itself. It's meant to reside in an existing application. It says you need to integrate it into your codebase, instead of running it as a dedicated server.</p> <p>The good part is it can extend itself to almost any use cases. The sad part is that it needs you to do more development work.</p> <h2 id="conclusions"><a href="#conclusions" class="header-anchor">#</a> Conclusions</h2> <h3 id="some-ideas"><a href="#some-ideas" class="header-anchor">#</a> Some ideas</h3> <p>You might want to implement one of below challenges as your side project.</p> <ul><li>More subclasses for executor, trigger, jobstore.</li> <li>A universal solution of running jobs in distributed worker nodes.</li> <li>A web interface for APScheduler.</li> <li>A RESTful API for managing APScheduler jobs.</li> <li>Make a service on top of APScheduler and let it run in Kubernetes cluster.</li> <li>The monitoring of APScheduler is weak. Provide a solution to enhance it. <a href="https://prometheus.io/docs/practices/instrumentation/#offline-processing" target="_blank" rel="noopener noreferrer">5<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="lesson-learned"><a href="#lesson-learned" class="header-anchor">#</a> Lesson learned</h3> <ul><li>Decide if you're going to build a utility, a service, or a framework before start writing the first line of code.</li> <li>Check if Object-oriented programming suites the case. If you have a variety of framework to support, consider it.</li> <li>Simplify the corner cases and make proper strategy and controlling parameters for them.</li> <li>Embed an event system for users so that they can do something on certain occasions.</li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/soasme/enqueuezero/edit/master/concrete-architecture/apscheduler.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.a5c5a90d.js" defer></script><script src="/assets/js/47.6ae747ba.js" defer></script>
  </body>
</html>
